<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .card {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .check-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <h1>ğŸ” NFC è°ƒè¯•å·¥å…·</h1>
    
    <div class="card">
        <h2>ç¯å¢ƒæ£€æŸ¥</h2>
        <div id="environment-check">
            <button onclick="checkEnvironment()">å¼€å§‹æ£€æŸ¥</button>
        </div>
        <div id="check-results"></div>
    </div>

    <div class="card">
        <h2>NFC åŠŸèƒ½æµ‹è¯•</h2>
        <div>
            <button id="scan-btn" onclick="startNFCTest()" disabled>å¼€å§‹ NFC æ‰«ææµ‹è¯•</button>
            <button id="stop-btn" onclick="stopNFCTest()" disabled>åœæ­¢æ‰«æ</button>
        </div>
        <div id="nfc-results" class="result"></div>
    </div>

    <div class="card">
        <h2>æ•…éšœæ’é™¤å»ºè®®</h2>
        <div id="troubleshooting"></div>
    </div>

    <script>
        let ndefReader = null;
        let isScanning = false;

        function checkEnvironment() {
            const results = document.getElementById('check-results');
            const checks = [];

            // æ£€æŸ¥æ“ä½œç³»ç»Ÿ
            const isAndroid = /Android/.test(navigator.userAgent);
            checks.push({
                name: 'Android æ“ä½œç³»ç»Ÿ',
                status: isAndroid,
                detail: isAndroid ? 'âœ“ æ£€æµ‹åˆ° Android' : 'âœ— å½“å‰ä¸æ˜¯ Android è®¾å¤‡'
            });

            // æ£€æŸ¥æµè§ˆå™¨
            const isChrome = /Chrome/.test(navigator.userAgent);
            checks.push({
                name: 'Chrome æµè§ˆå™¨',
                status: isChrome,
                detail: isChrome ? 'âœ“ æ£€æµ‹åˆ° Chrome' : 'âœ— å½“å‰ä¸æ˜¯ Chrome æµè§ˆå™¨'
            });

            // æ£€æŸ¥ Chrome ç‰ˆæœ¬
            const chromeMatch = navigator.userAgent.match(/Chrome\/(\d+)/);
            const chromeVersion = chromeMatch ? parseInt(chromeMatch[1]) : 0;
            const chromeOK = chromeVersion >= 89;
            checks.push({
                name: 'Chrome ç‰ˆæœ¬',
                status: chromeOK,
                detail: isChrome ? 
                    (chromeOK ? `âœ“ Chrome ${chromeVersion} (>= 89)` : `âœ— Chrome ${chromeVersion} (éœ€è¦ >= 89)`) :
                    '- æœªæ£€æµ‹åˆ° Chrome'
            });

            // æ£€æŸ¥ HTTPS
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            checks.push({
                name: 'HTTPS åè®®',
                status: isHTTPS,
                detail: isHTTPS ? 
                    `âœ“ ${location.protocol}//${location.hostname}` : 
                    `âœ— ${location.protocol}//${location.hostname} (éœ€è¦ HTTPS)`
            });

            // æ£€æŸ¥ Web NFC API
            const hasNFC = 'NDEFReader' in window;
            checks.push({
                name: 'Web NFC API',
                status: hasNFC,
                detail: hasNFC ? 'âœ“ NDEFReader å¯ç”¨' : 'âœ— NDEFReader ä¸å¯ç”¨'
            });

            // æ£€æŸ¥æƒé™ API
            const hasPermissions = 'permissions' in navigator;
            checks.push({
                name: 'æƒé™ API',
                status: hasPermissions,
                detail: hasPermissions ? 'âœ“ æƒé™ API å¯ç”¨' : 'âœ— æƒé™ API ä¸å¯ç”¨'
            });

            // ç”Ÿæˆæ£€æŸ¥ç»“æœ
            let html = '';
            checks.forEach(check => {
                const statusClass = check.status ? 'success' : 'error';
                html += `
                    <div class="check-item">
                        <span>${check.name}</span>
                        <span class="${statusClass}">${check.detail}</span>
                    </div>
                `;
            });

            results.innerHTML = html;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const canTest = isAndroid && isChrome && chromeOK && isHTTPS && hasNFC;
            document.getElementById('scan-btn').disabled = !canTest;

            // ç”Ÿæˆæ•…éšœæ’é™¤å»ºè®®
            generateTroubleshooting(checks);

            // è¯¦ç»†æ—¥å¿—
            console.group('NFC ç¯å¢ƒè¯¦ç»†æ£€æŸ¥');
            console.log('User Agent:', navigator.userAgent);
            console.log('Platform:', navigator.platform);
            console.log('Location:', location.href);
            console.log('Permissions API:', hasPermissions);
            console.log('NDEFReader:', hasNFC);
            console.groupEnd();
        }

        function generateTroubleshooting(checks) {
            const troubleshooting = document.getElementById('troubleshooting');
            let suggestions = [];

            if (!checks[0].status) { // ä¸æ˜¯ Android
                suggestions.push({
                    problem: 'å½“å‰è®¾å¤‡ä¸æ˜¯ Android',
                    solution: 'Web NFC API ç›®å‰ä»…åœ¨ Android è®¾å¤‡ä¸Šæ”¯æŒã€‚è¯·ä½¿ç”¨ Android æ‰‹æœºæˆ–å¹³æ¿ã€‚'
                });
            }

            if (!checks[1].status) { // ä¸æ˜¯ Chrome
                suggestions.push({
                    problem: 'å½“å‰æµè§ˆå™¨ä¸æ˜¯ Chrome',
                    solution: 'è¯·ä¸‹è½½å¹¶ä½¿ç”¨ Google Chrome æµè§ˆå™¨ã€‚'
                });
            }

            if (checks[1].status && !checks[2].status) { // Chrome ç‰ˆæœ¬è¿‡ä½
                suggestions.push({
                    problem: 'Chrome ç‰ˆæœ¬è¿‡ä½',
                    solution: 'è¯·å°† Chrome æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆè‡³å°‘ 89 ç‰ˆæœ¬ï¼‰ã€‚'
                });
            }

            if (!checks[3].status) { // ä¸æ˜¯ HTTPS
                suggestions.push({
                    problem: 'ç½‘ç«™ä¸æ˜¯é€šè¿‡ HTTPS è®¿é—®',
                    solution: 'Web NFC éœ€è¦å®‰å…¨ä¸Šä¸‹æ–‡ã€‚è¯·ç¡®ä¿ç½‘ç«™é€šè¿‡ HTTPS è®¿é—®ã€‚'
                });
            }

            if (checks[0].status && checks[1].status && checks[2].status && checks[3].status && !checks[4].status) {
                suggestions.push({
                    problem: 'Web NFC API ä¸å¯ç”¨',
                    solution: `
                        å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š<br>
                        1. åœ¨ Chrome åœ°å€æ è¾“å…¥ chrome://flags<br>
                        2. æœç´¢ "Experimental Web Platform features"<br>
                        3. å¯ç”¨è¯¥åŠŸèƒ½å¹¶é‡å¯æµè§ˆå™¨<br>
                        4. ç¡®ä¿è®¾å¤‡ NFC åŠŸèƒ½å·²å¼€å¯<br>
                        5. æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒ NFC ç¡¬ä»¶
                    `
                });
            }

            if (suggestions.length === 0) {
                troubleshooting.innerHTML = '<div class="success">âœ“ ç¯å¢ƒæ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥æµ‹è¯• NFC åŠŸèƒ½</div>';
            } else {
                let html = '';
                suggestions.forEach((s, i) => {
                    html += `
                        <div style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 6px;">
                            <strong class="warning">é—®é¢˜ ${i + 1}: ${s.problem}</strong><br>
                            <div style="margin-top: 5px;">${s.solution}</div>
                        </div>
                    `;
                });
                troubleshooting.innerHTML = html;
            }
        }

        async function startNFCTest() {
            const results = document.getElementById('nfc-results');
            results.textContent = 'æ­£åœ¨åˆå§‹åŒ– NFC æ‰«æ...\n';

            try {
                ndefReader = new NDEFReader();
                await ndefReader.scan();
                
                isScanning = true;
                document.getElementById('scan-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                
                results.textContent += 'âœ“ NFC æ‰«æå·²å¯åŠ¨\n';
                results.textContent += 'è¯·å°†è®¾å¤‡é è¿‘ NFC æ ‡ç­¾...\n\n';

                ndefReader.onreading = event => {
                    results.textContent += `--- NFC æ ‡ç­¾æ£€æµ‹åˆ° ---\n`;
                    results.textContent += `åºåˆ—å·: ${event.serialNumber}\n`;
                    results.textContent += `è®°å½•æ•°é‡: ${event.message.records.length}\n\n`;
                    
                    event.message.records.forEach((record, index) => {
                        results.textContent += `è®°å½• ${index + 1}:\n`;
                        results.textContent += `  ç±»å‹: ${record.recordType}\n`;
                        results.textContent += `  åª’ä½“ç±»å‹: ${record.mediaType || 'N/A'}\n`;
                        results.textContent += `  ç¼–ç : ${record.encoding || 'N/A'}\n`;
                        results.textContent += `  è¯­è¨€: ${record.lang || 'N/A'}\n`;
                        
                        try {
                            const decoder = new TextDecoder(record.encoding || 'utf-8');
                            const bytes = new Uint8Array(record.data.buffer, record.data.byteOffset, record.data.byteLength);
                            const text = decoder.decode(bytes);
                            results.textContent += `  å†…å®¹: ${text}\n`;
                        } catch (e) {
                            results.textContent += `  å†…å®¹: [äºŒè¿›åˆ¶æ•°æ®ï¼Œé•¿åº¦ ${record.data.byteLength} å­—èŠ‚]\n`;
                        }
                        results.textContent += '\n';
                    });
                    
                    results.scrollTop = results.scrollHeight;
                };

                ndefReader.onreadingerror = event => {
                    results.textContent += `âœ— è¯»å–é”™è¯¯: ${event}\n`;
                    results.scrollTop = results.scrollHeight;
                };

            } catch (error) {
                results.textContent += `âœ— å¯åŠ¨å¤±è´¥: ${error.message}\n`;
                results.textContent += `é”™è¯¯è¯¦æƒ…: ${error}\n`;
            }
        }

        function stopNFCTest() {
            if (ndefReader) {
                ndefReader.onreading = null;
                ndefReader.onreadingerror = null;
            }
            
            isScanning = false;
            document.getElementById('scan-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            
            const results = document.getElementById('nfc-results');
            results.textContent += '\n--- æ‰«æå·²åœæ­¢ ---\n';
            results.scrollTop = results.scrollHeight;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
        window.onload = checkEnvironment;
    </script>
</body>
</html>
